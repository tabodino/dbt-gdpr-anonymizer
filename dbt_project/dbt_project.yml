# ============================================
# GDPR Anonymizer - dbt Project Configuration
# ============================================

name: 'gdpr_anonymizer'
version: '1.0.0'
config-version: 2

# This setting configures which "profile" dbt uses for this project.
profile: 'gdpr_anonymizer'

# These configurations specify where dbt should look for different types of files.
# The `model-paths` config, for example, states that models in this project can be
# found in the "models/" directory. You probably won't need to change these!
model-paths: ["models"]
analysis-paths: ["analyses"]
test-paths: ["tests"]
seed-paths: ["seeds"]
macro-paths: ["macros"]
snapshot-paths: ["snapshots"]

clean-targets:         # directories to be removed by `dbt clean`
  - "target"
  - "dbt_packages"
  - "logs"


# ============================================
# GOBLAL VARIABLES
# ============================================


vars:
  # Salting key for hashing (CRITICAL)
  # To be set in .env : DBT_ANONYMIZATION_SALT
  salt_key: "{{ env_var('DBT_ANONYMIZATION_SALT', 'dev_salt_UNSAFE') }}"

  # GDPR Configuration
  k_anonymity_min: 5
  retention_days_default: 730
  gps_precision: 2

  # Project Metadata
  project_name: "GDPR Anonymizer"
  project_version: "1.0.0"
  data_owner: "DPO"

  # Anonymization levels by data type
  anonymization_config:
    high_sensitivity:
      - "email"
      - "phone"
      - "ssn"
      - "credit_card"
    medium_sensitivity:
      - "address"
      - "coordinates"
      - "postal_code"
    low_sensitivity:
      - "department"
      - "region"
      - "country"


# ============================================
# MODEL CONFIGURATION
# ============================================

# Configuring models
# Full documentation: https://docs.getdbt.com/docs/configuring-models

# In this example config, we tell dbt to build all models in the example/
# directory as views. These settings can be overridden in the individual model
# files using the `{{ config(...) }}` macro.
models:
  gdpr_anonymizer:
    # ==========================================
    # STAGING Layer
    # ==========================================
    staging:
      +materialized: view
      +schema: staging
      +tags: ['staging', 'raw_data']
      +docs:
        node_color: "#F7B731"  # Yellow for staging
      +meta:
        owner: "data_engineering"
        layer: "staging"
        contains_pii: true

    # ==========================================
    # INTERMEDIATE Layer (Anonymization)
    # ==========================================
    intermediate:
      +materialized: table
      +schema: anonymized
      +tags: ['intermediate', 'anonymized', 'pii_safe']
      +docs:
        node_color: "#5F27CD"  # Purple for anonymized
      +meta:
        owner: "data_engineering"
        layer: "intermediate"
        contains_pii: false
        anonymization_applied: true
    
    # ==========================================
    # MARTS Layer (Business Logic)
    # ==========================================
    marts:
      +materialized: table
      +schema: marts
      +tags: ['marts', 'open_data', 'public', 'pii_safe']
      +docs:
        node_color: "#00D2D3"  # Cyan for marts
      +meta:
        owner: "business_analytics"
        layer: "marts"
        contains_pii: false
        public_ready: true

      # Sub-domains by business area
      geographic:
        +tags: ['geography', 'maps']
        +meta:
          domain: "geographic_analysis"
    
      administrative:
        +tags: ['administration', 'organizations']
        +meta:
          domain: "administrative_services"

# ============================================
# SEEDS Configuration
# ============================================
    
seeds:
  gdpr_anonymizer:
    +schema: raw
    +tags: ['raw', 'seeds']
    +quote_columns: false

    # Seed configuration for a raw dataset containing public services information
    services_publics_raw:
      +column_types:
        service_id: varchar
        contact_email: varchar
        contact_phone: varchar
        postal_code: varchar


# ============================================
# TESTS Configuration
# ============================================

tests:
  gdpr_anonymizer:
    +store_failures: true
    +schema: test_results
    # Test configuration for intermediate models to ensure no PII is present
    intermediate:
      +severity: error
      +tags: ['anonymized', 'pii_safe']
      +meta:
        test_type: "pii_check"
        description: "Tests to ensure no PII is present in intermediate models"


# ============================================
# SNAPSHOTS Configuration
# ============================================

snapshots:
  gdpr_anonymizer:
    +schema: snapshots
    +tags: ['snapshots', 'historical_data']
    # Snapshot configuration for tracking changes in intermediate anonymized tables
    intermediate_snapshots:
      +target_database: "{{ target.database }}"
      +target_schema: "snapshots"
      +unique_key: "record_id"
      +strategy: timestamp
      +updated_at: "updated_at"
      +meta:
        description: "Snapshots to track historical changes in intermediate anonymized tables"


# ============================================
# DOCUMENTATION
# ============================================

dispatch:
  - macro_namespace: dbt
    search_order: ['gdpr_anonymizer', 'dbt']


# Hooks
on-run-start: 
  - "{{ log('Starting RGPD Anonymizer pipeline v' ~ var('project_version'), info=true) }}" 
  - "{{ log('Using salt_key: ' ~ (var('salt_key')[:10] ~ '...'), info=true) }}"

on-run-end: 
  - "{{ log('Pipeline completed successfully', info=true) }}" 
  - "{{ log_pii_summary() }}"  # Macro custom to resume PII


# ============================================
# OTHER CONFIGURATIONS
# ============================================

# Require dbt version
require-dbt-version: [">=1.11.0", "<2.0.0"]

# Query comment
query-comment:
  comment: "/* dbt:{{ node.unique_id }} - {{ run_started_at }} */"
  append: true

# Flags
flags:
  send_anonymous_usage_stats: false
  use_colors: true